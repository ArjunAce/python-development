# SQL 

## Queries

**INSERT**

```sql
-- Used to insert data
INSERT INTO table1 (column1, column2) 
VALUES 
  ('value1', 'value2'), 
  ('value3', 'value4');
```


**Update**

```sql
-- Used to update data
UPDATE employees
SET salary = salary * 1.05
WHERE department = 'Sales'
ORDER BY hire_date DESC
LIMIT 10;

-- In this example, the UPDATE statement modifies the salary column for the 10 most recently hired employees in the Sales department. The ORDER BY clause specifies that the rows should be processed in descending order of hire_date. The LIMIT clause limits the number of rows that will be updated to 10.
```

**SELECT**

```sql
-- Used to fetch data
SELECT * FROM customers;
```

**DISTINCT**

```sql
-- Fetch unique elements from table
SELECT DISTINCT(country) FROM customers;
```

**WHERE**

```sql
-- Used to filter data that fits condition
SELECT * FROM customers WHERE country = 'Mexico';
```

**AND, OR, NOT**

```sql
-- Used to apply boolean selection on filters
SELECT * FROM customers 
WHERE country = 'Germany' 
AND (city = 'Berlin' OR city = 'Dortmund')
AND city <> 'Hamburg';
```

**ORDER BY (DESC|ASC)**

```sql
-- Used to sort results
SELECT * FROM customers ORDER BY country DESC;
```

**LIMIT**

```sql
-- Used to limit the amount of results
SELECT * FROM customers LIMIT 10;
```

**MIN, MAX, COUNT, AVG, SUM**

```sql
-- Used to return the lowest or biggest value of a column
SELECT MAX(expense) FROM customers;
```

**LIKE**

```sql
-- Used to search for patterns in strings
SELECT * FROM customers WHERE country LIKE '%an%';
```

**Wildcars, CHARLIST**

```sql
-- Used to search for patterns in strings (_ - wildcard) , [CHARLIST] to match 
SELECT * FROM customers WHERE country LIKE '_[acd]%';
```

**IN**

```sql
-- Used to select over a set of elements
SELECT * FROM customers WHERE country IN 
    (SELECT country FROM suppliers);
```

**BETWEEN**

```sql
-- Used to find over a range of values
SELECT * FROM products WHERE price 
BETWEEN 10 AND 20;
```

**ALIASES**

```sql
-- Used to change column or table names
SELECT customer_name AS Customer,
CONCAT(address, ', ', zip_code) AS Address
FROM customers;
```

**JOIN**

Types of JOINs

| Type | Description |
| ---- | ----------- |
| INNER | Matching results (intersection) |
| LEFT OUTER | Left elements AND intersection | 
| RIGHT OUTER | Right elements AND intersection | 
| FULL OUTER | All elements in both sets | 

```sql
-- Use to merge two tables by certain key
SELECT orders.*, customers.*
FROM orders 
INNER JOIN customers 
ON customers.id_order = orders.id_order;
```

**SELF JOIN**

```sql
-- Used to merge same table 
SELECT B.name, A.name, B.city
FROM customers A, customers B
WHERE A.id <> B.id
AND A.city = B.city;
```

**UNION, UNION ALL**

`UNION ALL` do not remove duplicates, `UNION` does.

```sql
-- Used to add two sets 
SELECT city FROM customers
UNION
SELECT city FROM suppliers;
```

**GROUP BY**

```sql
-- Used to group elements
SELECT COUNT(o.order_id), c.country
FROM customers c
LEFT JOIN orders o 
ON c.customer_id = o.customer_id
GROUP BY country
ORDER BY count DESC;
```

**HAVING**

```sql
-- Used to filter group by results
SELECT customer_id, SUM(order_total) as total_revenue
FROM sales
GROUP BY customer_id
HAVING COUNT(order_id) >= 5;
--  Find the total revenue generated by each customer who has placed at least 5 orders.
```

**EXISTS**

```sql
-- Used to verify if exists an element
SELECT EXISTS (
    SELECT 1 FROM customers
    WHERE country = 'France');
```

**ANY, ALL**

```sql
-- Used to verify elements in query
SELECT product_name
FROM product
WHERE product_id = ALL (
    SELECT product_id FROM orders
    WHERE quantity > 10
);
```

**CASE (WHEN THEN)**

```sql
-- Used to apply IF/THEN statements
SELECT student_name, year, 
(CASE WHEN year = 'SR' THEN 'yes'
    ELSE NULL END) AS is_senior
FROM students;
```

**COALESCE**

```sql
-- Used to replace NULL values in columns
SELECT name,
COALESCE(description, 'No Description')
FROM products
ORDER BY description DESC
```

## Subqueries

```sql
-- Extract aggregated info from table
SELECT sub.category,
    AVG(sub.incidents) AS avg_incidents_per_month
FROM (
    SELECT EXTRACT('month' FROM cleaned_date) AS month,
            category,
            COUNT(1) AS incidents
        FROM tutorial.sf_crime_incidents_cleandate
        GROUP BY 1,2
    ) sub
GROUP BY 1
```

## Window functions

```sql
-- Transforms data and greates operations extending values to all the affected rows
SELECT start_terminal,
    duration_seconds,
    SUM(duration_seconds) OVER (PARTITION BY start_terminal) AS start_terminal_sum,
    (duration_seconds/SUM(duration_seconds) OVER (PARTITION BY start_terminal))*100 AS pct_of_total_time
FROM tutorial.dc_bikeshare_q1_2012
ORDER BY 1, 4 DESC
```

**ROW_NUMBER()**

```sql
-- Assigns row number for each element
SELECT start_terminal,
    start_time,
    duration_seconds,
    ROW_NUMBER() OVER (ORDER BY start_time)
                AS row_number
FROM tutorial.dc_bikeshare_q1_2012
```

**RANK(), DENSE_RANK()**

```sql
-- RANK: assigns number for each partition and skips the count when values repeat
-- DENSE_RANK: assigns number for each partition and keeps the count when values repeated 
SELECT start_terminal,
    duration_seconds,
    RANK() OVER (PARTITION BY start_terminal
                ORDER BY start_time)
            AS rank
FROM tutorial.dc_bikeshare_q1_2012
```

**NTILE(#bucket)**

```sql
-- Asigns respective bucket of values (quartiles, percentiles, etc)
SELECT start_terminal,
    duration_seconds,
    NTILE(4) OVER
        (PARTITION BY start_terminal ORDER BY duration_seconds)
        AS quartile,
    NTILE(5) OVER
        (PARTITION BY start_terminal ORDER BY duration_seconds)
        AS quintile,
    NTILE(100) OVER
        (PARTITION BY start_terminal ORDER BY duration_seconds)
        AS percentile
FROM tutorial.dc_bikeshare_q1_2012
ORDER BY start_terminal, duration_seconds
```

**LAG(), LEAD()**

```sql
-- Retrieves previous (LAG) or following (LEAD) values of rows from a column 
SELECT start_terminal,
    duration_seconds,
    LAG(duration_seconds, 1) OVER
        (PARTITION BY start_terminal ORDER BY duration_seconds) AS lag,
    LEAD(duration_seconds, 1) OVER
        (PARTITION BY start_terminal ORDER BY duration_seconds) AS lead
FROM tutorial.dc_bikeshare_q1_2012
ORDER BY start_terminal, duration_seconds
```

**PIVOTING**

```sql
-- Used to transform data and perform aggregations
SELECT conference,
    SUM(players) AS total_players,
    SUM(CASE WHEN year = 'FR' THEN players ELSE NULL END) AS fr,
    SUM(CASE WHEN year = 'SO' THEN players ELSE NULL END) AS so,
    SUM(CASE WHEN year = 'JR' THEN players ELSE NULL END) AS jr,
    SUM(CASE WHEN year = 'SR' THEN players ELSE NULL END) AS sr
FROM (
    SELECT teams.conference AS conference,
            players.year,
            COUNT(1) AS players
        FROM benn.college_football_players players
        JOIN benn.college_football_teams teams
        ON teams.school_name = players.school_name
        GROUP BY 1,2
    ) sub
GROUP BY 1
ORDER BY 2 DESC
```